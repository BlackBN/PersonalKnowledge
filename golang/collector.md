# golang 垃圾收集器

垃圾回收(Garbage Collection，简称GC)是编程语言中提供的自动的内存管理机制，自动释放不需要的对象，让出存储器资源，无需程序员手动执行。
​Golang中的垃圾回收主要应用三色标记法，GC过程和其他用户goroutine可并发运行，但需要一定时间的STW(stop the world)，STW的过程中，CPU不执行用户代码，全部用于垃圾回收，这个过程的影响很大，Golang进行了多次的迭代优化来解决这个问题。

## GO V1.3 标记清扫算法

算法过程：

1. 暂停程序业务逻辑，即STW（Stop The World）。
2. 标记：从根对象出发查找并标记堆中所有存活的对象。
3. 清扫：遍历堆中所有对象，回收未被标记的垃圾对象及将回收的内存加入到空闲链表中。

缺点：

1. 在执行标记清扫流程前，需要停止程序的业务逻辑，导致程序执行过程出现卡顿（主要问题）。
2. 需要遍历整个Heap。
3. 在清扫阶段后容易出现内存碎片。

## GO V1.5 三色并发标记算法

三色标记将堆中对象分为三种颜色（即三种状态）：
白色：潜在的垃圾对象，其内存可能会被垃圾收集器回收；
灰色：该状态是在执行三色标记算法过程的一个中间状态；
黑色：该状态是三色标记算法执行完以后 不会被垃圾收集器回收的对象的最终状态。

算法过程：
在垃圾收集器开始工作时，程序中不存在任何的黑色对象，垃圾收集的根对象会被标记成灰色，垃圾收集器只会从灰色对象集合中取出对象开始扫描，当灰色集合中不存在任何对象时，标记阶段就会结束。

1. 从灰色对象的集合中选择一个灰色对象并将其标记成黑色；
2. 将这个黑色对象指向的所有对象都标记成灰色，保证该对象和被该对象引用的对象都不会被回收；
3. 重复上述两个步骤直到对象图中不存在灰色对象。

三色的标记清除的标记阶段结束之后，应用程序的堆中就不存在任何的灰色对象，我们只能看到黑色的存活对象以及白色的垃圾对象，垃圾收集器可以回收这些白色的垃圾。

## GO V1.8 混合写屏障机制

## 杂项

内存泄漏（Memory Leak）是指程序中已动态分配的堆内存由于某种原因程序未释放或无法释放，造成系统内存的浪费，导致程序运行速度减慢甚至系统崩溃等严重后果。内存泄漏缺陷具有隐蔽性、积累性的特征，比其他内存非法访问错误更难检测。因为内存泄漏的产生原因是内存块未被释放，属于遗漏型缺陷而不是过错型缺陷。

内存溢出(Out Of Memory，简称OOM)是指应用系统中存在无法回收的内存或使用的内存过多，最终使得程序运行要用到的内存大于能提供的最大内存。此时程序就运行不了，系统会提示内存溢出，有时候会自动关闭软件，重启电脑或者软件后释放掉一部分内存又可以正常运行该软件，而由系统配置、数据流、用户代码等原因而导致的内存溢出错误，即使用户重新执行任务依然无法避免。

悬挂指针：当指针所指向的对象被释放，但是该指针没有任何改变，以至于其仍然指向已经被回收的内存地址，这种情况下该指针被称为悬挂指针。

野指针：未初始化的指针被称为野指针。
